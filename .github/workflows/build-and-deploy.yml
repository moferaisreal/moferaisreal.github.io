name: Build and Deploy Portfolio

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Detect and build projects automatically
        run: |
          echo "ğŸ” Procurando projetos que precisam de build..."

          # FunÃ§Ã£o para fazer build de um projeto
          build_project() {
            local project_dir=$1
            echo ""
            echo "ğŸ“¦ Iniciando build do projeto: $project_dir"
            echo "================================================"
            
            cd "$project_dir"
            
            if [ -f "package.json" ]; then
              echo "âœ… package.json encontrado"
              
              # Instalar dependÃªncias
              echo "ğŸ“¥ Instalando dependÃªncias..."
              npm install --production=false
              
              # Tentar diferentes comandos de build em ordem de prioridade
              echo "ğŸ”¨ Tentando comandos de build..."
              
              if npm run build 2>/dev/null; then
                echo "âœ… âœ¨ Build realizado com sucesso usando: npm run build"
              elif npm run prod 2>/dev/null; then
                echo "âœ… âœ¨ Build realizado com sucesso usando: npm run prod"
              elif npx grunt build 2>/dev/null; then
                echo "âœ… âœ¨ Build realizado com sucesso usando: grunt build"
              elif npx grunt 2>/dev/null; then
                echo "âœ… âœ¨ Build realizado com sucesso usando: grunt"
              elif npx gulp build 2>/dev/null; then
                echo "âœ… âœ¨ Build realizado com sucesso usando: gulp build"
              elif npx gulp 2>/dev/null; then
                echo "âœ… âœ¨ Build realizado com sucesso usando: gulp"
              else
                echo "âš ï¸  Nenhum comando de build padrÃ£o funcionou para $project_dir"
                echo "ğŸ“‹ Scripts disponÃ­veis no package.json:"
                npm run 2>/dev/null | grep -E "^  [a-zA-Z]" || echo "   Nenhum script encontrado"
              fi
              
              # Verificar se build gerou arquivos
              if [ -d "dist" ]; then
                echo "ğŸ“ Pasta dist/ criada com sucesso"
                ls -la dist/ | head -10
              elif [ -d "build" ]; then
                echo "ğŸ“ Pasta build/ criada com sucesso"  
                ls -la build/ | head -10
              else
                echo "ğŸ“ Verificando arquivos gerados na raiz do projeto..."
                ls -la | grep -E "\.(html|css|js)$" | head -5
              fi
              
            else
              echo "âš ï¸  package.json nÃ£o encontrado em $project_dir - pulando"
            fi
            
            cd ..
            echo "================================================"
          }

          # Escanear todos os diretÃ³rios procurando por package.json
          projects_found=0
          for dir in */; do
            # Pular diretÃ³rios que nÃ£o sÃ£o projetos
            if [[ "$dir" == "node_modules/" || "$dir" == ".git/" || "$dir" == ".github/" ]]; then
              continue
            fi
            
            if [ -d "$dir" ] && [ -f "${dir}package.json" ]; then
              echo "ğŸ¯ Projeto encontrado: $dir"
              build_project "$dir"
              projects_found=$((projects_found + 1))
            fi
          done

          if [ $projects_found -eq 0 ]; then
            echo "â„¹ï¸  Nenhum projeto com package.json encontrado"
            echo "ğŸ“ Projetos sem build continuarÃ£o funcionando normalmente"
          else
            echo ""
            echo "ğŸ‰ Build completo! $projects_found projeto(s) processado(s)"
          fi

      - name: Verify build results
        run: |
          echo "ğŸ“Š Verificando resultados do build..."
          echo ""
          echo "ğŸ“ Estrutura de diretÃ³rios apÃ³s build:"
          find . -maxdepth 2 -type d -name "dist" -o -name "build" | sort
          echo ""
          echo "ğŸ“„ Arquivos HTML principais:"
          find . -maxdepth 2 -name "index.html" | sort

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          # Manter arquivos buildados, excluir arquivos de desenvolvimento
          exclude_assets: ".github,node_modules,src,gulpfile.js,Gruntfile.js,gruntfile.js,package*.json,*.md,.gitignore,build-portfolio.sh,.sass-cache,.tmp"

      - name: Build Summary
        if: always()
        run: |
          echo ""
          echo "ğŸ“‹ RESUMO DO BUILD"
          echo "=================="
          echo "âœ… Projetos que nÃ£o precisam de build: funcionam automaticamente"
          echo "ğŸ”¨ Projetos que precisam de build: processados automaticamente"  
          echo "ğŸš€ Deploy: realizado para GitHub Pages"
          echo ""
          echo "Para adicionar um novo projeto:"
          echo "1. Coloque a pasta com package.json configurado"
          echo "2. FaÃ§a commit - build serÃ¡ automÃ¡tico!"
          echo ""
