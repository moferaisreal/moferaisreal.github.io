name: Build and Deploy Portfolio

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: portfolio-source/package-lock.json

      - name: Install dependencies
        working-directory: ./portfolio-source
        run: |
          echo "ğŸ“¥ Instalando dependÃªncias..."
          npm ci

      - name: Build project
        working-directory: ./portfolio-source
        run: |
          echo "ğŸ”¨ Construindo projeto React..."
          npm run build
          echo "âœ… Build concluÃ­do!"

      - name: Verify build in root
        run: |
          echo "ğŸ“Š Verificando arquivos na raiz..."
          echo ""
          echo "Arquivos principais:"
          ls -lah | grep -E "index.html|assets|favicon"
          echo ""
          if [ -f "index.html" ]; then
            echo "âœ… index.html encontrado na raiz!"
          else
            echo "âŒ ERRO: index.html nÃ£o encontrado na raiz!"
            exit 1
          fi

          if [ -d "assets" ]; then
            echo "âœ… Pasta assets/ encontrada!"
            echo "ConteÃºdo de assets/:"
            ls -lah assets/ | head -10
          else
            echo "âš ï¸  Pasta assets/ nÃ£o encontrada"
          fi

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          # Excluir cÃ³digo fonte e arquivos desnecessÃ¡rios
          exclude_assets: '.github,portfolio-source,old-projects,backup-*,node_modules,.gitignore,reorganizar.sh'

      - name: Build Summary
        if: always()
        run: |
          echo ""
          echo "ğŸ“‹ RESUMO DO DEPLOY"
          echo "=================="
          echo "âœ… Build: ConcluÃ­do"
          echo "âœ… Arquivos na raiz do repositÃ³rio"
          echo "ğŸš€ Deploy: GitHub Pages"
          echo "ğŸŒ URL: https://moferaisreal.github.io"
          echo ""
          echo "ğŸ“ Estrutura:"
          echo "  - PortfÃ³lio React: Raiz do site"
          echo "  - Projetos antigos: /old-projects/"
          echo "  - CÃ³digo fonte: /portfolio-source/ (nÃ£o publicado)"
          echo ""
