name: Build and Deploy Portfolio

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          echo "ğŸ“¥ Instalando dependÃªncias..."
          if [ -f "package-lock.json" ]; then
            echo "âœ… Usando npm ci (mais rÃ¡pido e confiÃ¡vel)"
            npm ci
          else
            echo "âš ï¸  package-lock.json nÃ£o encontrado, usando npm install"
            npm install
          fi

      - name: Build project
        run: |
          echo "ğŸ”¨ Construindo projeto React + Vite..."
          npm run build

      - name: Verify build
        run: |
          echo "ğŸ“Š Verificando build..."
          if [ -d "dist" ]; then
            echo "âœ… Build criado com sucesso!"
            echo "ğŸ“ ConteÃºdo do diretÃ³rio dist:"
            ls -lah dist/
            echo ""
            echo "ğŸ“„ Arquivos importantes:"
            echo "  index.html: $([ -f "dist/index.html" ] && echo 'âœ…' || echo 'âŒ')"
            echo "  assets/: $([ -d "dist/assets" ] && echo 'âœ…' || echo 'âŒ')"
            
            if [ ! -f "dist/index.html" ]; then
              echo ""
              echo "âŒ ERRO: dist/index.html nÃ£o foi criado!"
              exit 1
            fi
          else
            echo "âŒ Erro: DiretÃ³rio dist nÃ£o foi criado!"
            exit 1
          fi

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          force_orphan: true

      - name: Build Summary
        if: always()
        run: |
          echo ""
          echo "ğŸ“‹ RESUMO DO DEPLOY"
          echo "=================="
          echo "âœ… Build: ConcluÃ­do"
          echo "âœ… Deploy: GitHub Pages"
          echo "ğŸŒ URL: https://moferaisreal.github.io/"
          echo ""
          echo "â±ï¸ Aguarde 2-5 minutos para o site ficar online"
          echo ""
