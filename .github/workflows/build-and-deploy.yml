name: Build All Projects and Deploy

on:
  push:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: ðŸ—ï¸ Build All Projects
        run: |
          # Criar pasta para reunir todos os builds
          mkdir -p _site

          # FunÃ§Ã£o para buildar projetos
          build_project() {
            local project_dir=$1
            echo "ðŸ”¨ Building $project_dir..."
            
            if [ -d "$project_dir" ]; then
              cd "$project_dir"
              
              # Instalar dependÃªncias se existir package.json
              if [ -f "package.json" ]; then
                npm install
                
                # Verificar se Ã© Grunt ou Gulp e fazer build
                if [ -f "Gruntfile.js" ]; then
                  npx grunt build || npx grunt || echo "âŒ Build failed for $project_dir"
                elif [ -f "gulpfile.js" ]; then
                  npx gulp build || npx gulp || echo "âŒ Build failed for $project_dir"
                fi
                
                # Copiar arquivos buildados para _site (mesmo se build falhou)
                if [ -d "dist" ]; then
                  mkdir -p "../_site/$project_dir"
                  cp -r dist/* "../_site/$project_dir/" 2>/dev/null || true
                  # TambÃ©m copiar index.html da raiz do projeto se existir
                  cp -f index.html "../_site/$project_dir/" 2>/dev/null || true
                elif [ -d "build" ]; then
                  mkdir -p "../_site/$project_dir"
                  cp -r build/* "../_site/$project_dir/" 2>/dev/null || true
                  cp -f index.html "../_site/$project_dir/" 2>/dev/null || true
                else
                  # Se nÃ£o hÃ¡ pasta de build, copia arquivos principais
                  mkdir -p "../_site/$project_dir"
                  cp -f *.html "../_site/$project_dir/" 2>/dev/null || true
                  cp -rf src "../_site/$project_dir/" 2>/dev/null || true
                  cp -rf css "../_site/$project_dir/" 2>/dev/null || true
                  cp -rf js "../_site/$project_dir/" 2>/dev/null || true
                  cp -rf images "../_site/$project_dir/" 2>/dev/null || true
                fi
              fi
              
              cd ..
            fi
          }

          # Buildar cada projeto que tem build tools
          build_project "exercicio_grunt"

          build_project "projeto_04"
          # Adicione outros projetos aqui conforme necessÃ¡rio

          # Copiar arquivos da raiz se existirem (index.html, etc.)
          cp -f *.html _site/ 2>/dev/null || true
          cp -rf images _site/ 2>/dev/null || true

      - name: ðŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
